{"ID":"20241016092346-2qqsnsc","Spec":"1","Type":"NodeDocument","Properties":{"id":"20241016092346-2qqsnsc","title":"CSRF跨站请求伪造","type":"doc","updated":"20241020152935"},"Children":[{"ID":"20241016092347-m0jgomj","Type":"NodeParagraph","Properties":{"id":"20241016092347-m0jgomj","updated":"20241016092347"},"Children":[{"Type":"NodeText","Data":"可以看这个视频：【跨站请求伪造CSRF攻击的原理以及防范措施】 https://www.bilibili.com/video/BV1UH4y1M7Dg/?share_source=copy_web\u0026vd_source=29909144aff7d2c1451e8d294e9a5437"}]},{"ID":"20241016092348-yx3284w","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241016092348-yx3284w","updated":"20241016092348"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"原理"}]},{"ID":"20241016092349-5lb5pto","Type":"NodeParagraph","Properties":{"id":"20241016092349-5lb5pto","updated":"20241016092349"},"Children":[{"Type":"NodeText","Data":"跨站请求伪造（Cross-Site Request Forgery，简称 CSRF）是一种网络攻击，攻击者诱导受害者在未经授权的情况下，向另一个网站发送请求。CSRF 攻击的主要目标是利用用户的身份验证状态，让攻击者能够冒充用户执行操作，通常用于修改用户的敏感信息或进行交易。"}]},{"ID":"20241016092350-bw93usq","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20241016092350-bw93usq","updated":"20241016092350"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"CSRF 攻击的原理"}]},{"ID":"20241016092351-tu2tjws","Type":"NodeList","ListData":{"Typ":1,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20241016092351-tu2tjws","updated":"20241016092351"},"Children":[{"ID":"20241016092352-87f84es","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20241016092352-87f84es","updated":"20241016092352"},"Children":[{"ID":"20241016092353-nk66u3p","Type":"NodeParagraph","Properties":{"id":"20241016092353-nk66u3p","updated":"20241016092353"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"利用用户的登录状态"},{"Type":"NodeText","Data":"：CSRF 攻击利用用户在目标网站上已经登录的事实。假设用户在网站 A 上登录了他们的账户并且处于认证状态（有有效的 session 或 cookie）。"}]}]},{"ID":"20241016092354-16b7esx","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20241016092354-16b7esx","updated":"20241016092354"},"Children":[{"ID":"20241016092355-3zhgsq7","Type":"NodeParagraph","Properties":{"id":"20241016092355-3zhgsq7","updated":"20241016092355"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"构造恶意请求"},{"Type":"NodeText","Data":"：攻击者通过在其他网站或平台（如邮件、聊天、恶意广告等）嵌入一个恶意链接或表单，诱导用户点击或加载该页面。这个请求会伪装成合法的请求，并包含需要发送到网站 A 的操作（例如提交表单、执行转账、修改配置等）。"}]}]},{"ID":"20241016092356-hnkwaxw","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20241016092356-hnkwaxw","updated":"20241016092356"},"Children":[{"ID":"20241016092357-f0il5oq","Type":"NodeParagraph","Properties":{"id":"20241016092357-f0il5oq","updated":"20241016092357"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"未授权的操作"},{"Type":"NodeText","Data":"：由于用户已经登录，浏览器会自动携带用户的认证信息（如 cookie）。这样，网站 A 会误以为是用户自己发起的请求，从而执行相应的操作。"}]}]}]},{"ID":"20241016092358-ken1pzb","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20241016092358-ken1pzb","updated":"20241016092358"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"举个例子"}]},{"ID":"20241016092359-bt7liek","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20241016092359-bt7liek","updated":"20241016092359"},"Children":[{"ID":"20241016092360-2g77ndm","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20241016092360-2g77ndm","updated":"20241016092360"},"Children":[{"ID":"20241016092361-ub72unq","Type":"NodeParagraph","Properties":{"id":"20241016092361-ub72unq","updated":"20241016092361"},"Children":[{"Type":"NodeText","Data":"用户登录了银行网站 A，执行了正常的转账操作。"}]}]},{"ID":"20241016092362-j926d01","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20241016092362-j926d01","updated":"20241016092362"},"Children":[{"ID":"20241016092363-v1y7meb","Type":"NodeParagraph","Properties":{"id":"20241016092363-v1y7meb","updated":"20241016092363"},"Children":[{"Type":"NodeText","Data":"之后，用户没有登出银行网站 A，继续浏览其他网站 B。"}]}]},{"ID":"20241016092364-r4x14rt","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20241016092364-r4x14rt","updated":"20241016092364"},"Children":[{"ID":"20241016092365-05806yc","Type":"NodeParagraph","Properties":{"id":"20241016092365-05806yc","updated":"20241016092365"},"Children":[{"Type":"NodeText","Data":"网站 B 中嵌入了恶意代码，用户点击了该网站上的一个链接，该链接发送了一个转账请求到银行网站 A。"}]}]},{"ID":"20241016092366-cjymf7t","Type":"NodeListItem","Data":"4","ListData":{"Typ":1,"Tight":true,"Start":4,"Delimiter":46,"Padding":3,"Marker":"NA==","Num":4},"Properties":{"id":"20241016092366-cjymf7t","updated":"20241016092366"},"Children":[{"ID":"20241016092367-dnbibfc","Type":"NodeParagraph","Properties":{"id":"20241016092367-dnbibfc","updated":"20241016092367"},"Children":[{"Type":"NodeText","Data":"用户的浏览器会自动携带银行网站的 cookie，从而银行网站无法区分这是恶意的请求还是合法请求，于是就执行了转账操作。"}]}]}]},{"ID":"20241016092368-t931gfu","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20241016092368-t931gfu","updated":"20241020152623"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"防御措施"}]},{"ID":"20241016092369-do0dqvl","Type":"NodeParagraph","Properties":{"id":"20241016092369-do0dqvl","updated":"20241016092369"},"Children":[{"Type":"NodeText","Data":"为了防止 CSRF 攻击，常见的防御方法包括："}]},{"ID":"20241016092370-s8bf700","Type":"NodeList","ListData":{"Typ":1,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20241016092370-s8bf700","updated":"20241016092370"},"Children":[{"ID":"20241016092371-qj14kea","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20241016092371-qj14kea","updated":"20241016092371"},"Children":[{"ID":"20241016092372-5avttkd","Type":"NodeParagraph","Properties":{"id":"20241016092372-5avttkd","updated":"20241016092372"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"CSRF Token"},{"Type":"NodeText","Data":"：在每次提交表单或请求时，服务器生成一个唯一的 token（令牌），并嵌入在页面中。用户提交请求时，服务器会检查这个 token 是否匹配，防止第三方伪造请求。"}]}]},{"ID":"20241016092373-pr94hcd","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20241016092373-pr94hcd","updated":"20241016092373"},"Children":[{"ID":"20241016092374-sqlq7f7","Type":"NodeParagraph","Properties":{"id":"20241016092374-sqlq7f7","updated":"20241016092374"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a strong","TextMarkTextContent":"SameSite Cookie 属性"},{"Type":"NodeText","Data":"：设置 cookie 的 SameSite 属性，可以限制浏览器是否"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkTextContent":"允许在跨站请求中携带 cookie"},{"Type":"NodeText","Data":"。"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"SameSite=Lax"},{"Type":"NodeText","Data":" 或 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"SameSite=Strict"},{"Type":"NodeText","Data":" 可以有效防御大部分 CSRF 攻击。"}]}]},{"ID":"20241016092375-dha5cai","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20241016092375-dha5cai","updated":"20241016092375"},"Children":[{"ID":"20241016092376-mbtgg8k","Type":"NodeParagraph","Properties":{"id":"20241016092376-mbtgg8k","updated":"20241016092376"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"双重提交 cookie"},{"Type":"NodeText","Data":"：服务器将 CSRF token 存储在 cookie 中，同时在表单中嵌入该 token，服务器收到请求后检查 cookie 中的 token 和表单中的 token 是否一致。"}]}]},{"ID":"20241016092377-mf14ewn","Type":"NodeListItem","Data":"4","ListData":{"Typ":1,"Tight":true,"Start":4,"Delimiter":46,"Padding":3,"Marker":"NA==","Num":4},"Properties":{"id":"20241016092377-mf14ewn","updated":"20241016092377"},"Children":[{"ID":"20241016092378-5ofid5d","Type":"NodeParagraph","Properties":{"id":"20241016092378-5ofid5d","updated":"20241016092378"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"验证 Referer 或 Origin 头"},{"Type":"NodeText","Data":"：检查请求头中的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Referer"},{"Type":"NodeText","Data":" 或 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Origin"},{"Type":"NodeText","Data":"，确保请求是从同一来源发送的。如果来源不合法，则拒绝请求。"}]}]}]},{"ID":"20241016092379-bvj2e7v","Type":"NodeParagraph","Properties":{"id":"20241016092379-bvj2e7v","updated":"20241016092379"},"Children":[{"Type":"NodeText","Data":"通过这些防御措施，服务器能够有效防止 CSRF 攻击，保证用户的请求是由他们自己主动发起的，而不是被恶意网站伪造的。"}]},{"ID":"20241020152603-k319z49","Type":"NodeParagraph","Properties":{"id":"20241020152603-k319z49","updated":"20241020152603"}},{"ID":"20241020152604-k27bn9v","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241020152604-k27bn9v","updated":"20241020152935"},"Children":[{"Type":"NodeText","Data":"JWT为什么可以避免CSRF"}]},{"ID":"20241020152628-vulyq25","Type":"NodeParagraph","Properties":{"id":"20241020152628-vulyq25","updated":"20241020152935"},"Children":[{"Type":"NodeText","Data":"原文："},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://mp.weixin.qq.com/s/bgXgV1zZ0s9LAcdLaupGFQ","TextMarkTextContent":"决定放弃使用JWT了！"}]},{"ID":"20241020152636-a4myalm","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20241020152636-a4myalm","updated":"20241020153023"},"Children":[{"Type":"NodeText","Data":"什么是CSRF"}]},{"ID":"20241020152633-m60nmcm","Type":"NodeParagraph","Properties":{"id":"20241020152633-m60nmcm","updated":"20241020152633"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"CSRF（Cross Site Request Forgery）"},{"Type":"NodeText","Data":" 一般被翻译为 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"跨站请求伪造"},{"Type":"NodeText","Data":"，属于网络攻击领域范围。相比于 SQL 脚本注入、XSS 等安全攻击方式，CSRF 的知名度并没有它们高。但是，它的确是我们开发系统时必须要考虑的安全隐患。就连业内技术标杆 Google 的产品 Gmail 也曾在 2007 年的时候爆出过 CSRF 漏洞，这给 Gmail 的用户造成了很大的损失。"}]},{"ID":"20241020152633-mlp9quy","Type":"NodeParagraph","Properties":{"id":"20241020152633-mlp9quy","updated":"20241020152633"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"那么究竟什么是跨站请求伪造呢？"},{"Type":"NodeText","Data":" 简单来说就是用你的身份去做一些不好的事情（发送一些对你不友好的请求比如恶意转账）。"}]},{"ID":"20241020152633-y5b7v44","Type":"NodeParagraph","Properties":{"id":"20241020152633-y5b7v44","updated":"20241020152756"},"Children":[{"Type":"NodeText","Data":"举个简单的例子：小壮登录了某网上银行，他来到了网上银行的帖子区，看到一个帖子下面有一个链接写着“科学理财，年盈利率过万”，小壮好奇的点开了这个链接，结果发现自己的账户少了 10000 元。这是这么回事呢？原来黑客在链接中藏了一个请求，这个请求直接利用小壮的身份给银行发送了一个转账请求，也就是"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color6);"},"TextMarkType":"text","TextMarkTextContent":"通过你的 Cookie 向银行发出请求"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color6);\"}"},{"Type":"NodeText","Data":"。"}]},{"ID":"20241020152633-ri5o5v3","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241020152633-ri5o5v3","updated":"20241020152659"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aHRtbA=="},{"Type":"NodeCodeBlockCode","Data":"\u003ca src=\"http://www.mybank.com/Transfer?bankId=11\u0026money=10000\"\n  \u003e科学理财，年盈利率过万\u003c/a\n\u003e\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241020152633-gxllfhq","Type":"NodeParagraph","Properties":{"id":"20241020152633-gxllfhq","updated":"20241020152633"},"Children":[{"Type":"NodeText","Data":"CSRF 攻击需要依赖 Cookie ，Session 认证中 Cookie 中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SessionID"},{"Type":"NodeText","Data":"​ 是由浏览器发送到服务端的，只要发出请求，Cookie 就会被携带。借助这个特性，即使黑客无法获取你的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SessionID"},{"Type":"NodeText","Data":"​，只要让你误点攻击链接，就可以达到攻击效果。"}]},{"ID":"20241020152633-thgapre","Type":"NodeParagraph","Properties":{"id":"20241020152633-thgapre","updated":"20241020152843"},"Children":[{"Type":"NodeText","Data":"另外，"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"并不是必须点击链接才可以达到攻击效果"},{"Type":"NodeText","Data":"，很多时候，只要你打开了某个页面，CSRF 攻击就会发生。"}]},{"ID":"20241020152633-z4ri82o","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241020152633-z4ri82o","updated":"20241020152655"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aHRtbA=="},{"Type":"NodeCodeBlockCode","Data":"\u003cimg src=\"http://www.mybank.com/Transfer?bankId=11\u0026money=10000\" /\u003e\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241020153014-mfjuwzj","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20241020153014-mfjuwzj","updated":"20241020153054"},"Children":[{"Type":"NodeText","Data":"JWT为什么可以避免"}]},{"ID":"20241020153014-onaw7y8","Type":"NodeParagraph","Properties":{"id":"20241020153014-onaw7y8","updated":"20241020153014"},"Children":[{"Type":"NodeText","Data":"一般情况下我们使用 JWT 的话，在我们登录成功获得 JWT 之后，一般会选择存放在 localStorage 中。前端的每一个请求后续都会附带上这个 JWT，整个过程压根不会涉及到 Cookie。因此，即使你点击了非法链接发送了请求到服务端，这个非法请求也是不会携带 JWT 的，所以这个请求将是非法的。"}]},{"ID":"20241020153014-aimalva","Type":"NodeParagraph","Properties":{"id":"20241020153014-aimalva","updated":"20241020153014"},"Children":[{"Type":"NodeText","Data":"总结来说就一句话："},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"使用 JWT 进行身份验证不需要依赖 Cookie ，因此可以避免 CSRF 攻击。"}]},{"ID":"20241020153014-51fz1bc","Type":"NodeParagraph","Properties":{"id":"20241020153014-51fz1bc","updated":"20241020153014"},"Children":[{"Type":"NodeText","Data":"不过，这样也会存在 XSS 攻击的风险。为了避免 XSS 攻击，你可以选择将 JWT 存储在标记为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"httpOnly"},{"Type":"NodeText","Data":"​ 的 Cookie 中。但是，这样又导致了你必须自己提供 CSRF 保护，因此，实际项目中我们通常也不会这么做。"}]},{"ID":"20241020153014-34fdd19","Type":"NodeParagraph","Properties":{"id":"20241020153014-34fdd19","updated":"20241020153014"},"Children":[{"Type":"NodeText","Data":"常见的避免 XSS 攻击的方式是过滤掉请求中存在 XSS 攻击风险的可疑字符串。"}]},{"ID":"20241020153014-mloudwn","Type":"NodeParagraph","Properties":{"id":"20241020153014-mloudwn","updated":"20241020153014"},"Children":[{"Type":"NodeText","Data":"在 Spring 项目中，我们一般是通过创建 XSS 过滤器来实现的。"}]},{"ID":"20241020153014-cuj8las","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241020153014-cuj8las","updated":"20241020153053"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"@Component\n@Order(Ordered.HIGHEST_PRECEDENCE)\npublic class XSSFilter implements Filter {\n\n    @Override\n    public void doFilter(ServletRequest request, ServletResponse response,\n      FilterChain chain) throws IOException, ServletException {\n        XSSRequestWrapper wrappedRequest =\n          new XSSRequestWrapper((HttpServletRequest) request);\n        chain.doFilter(wrappedRequest, response);\n    }\n\n    // other methods\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241020153054-cthpldg","Type":"NodeParagraph","Properties":{"id":"20241020153054-cthpldg","updated":"20241020153054"}}]}