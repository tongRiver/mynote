/*!
 * MIT License
 *
 * Copyright (c) 2024 Jixiong Su
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */(()=>{"use strict";var d={};d.d=(c,r)=>{for(var l in r)d.o(r,l)&&!d.o(c,l)&&Object.defineProperty(c,l,{enumerable:!0,get:r[l]})},d.o=(c,r)=>Object.prototype.hasOwnProperty.call(c,r),d.r=c=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(c,"__esModule",{value:!0})};var f={};d.r(f),d.d(f,{default:()=>g});const u=require("siyuan");class g extends u.Plugin{constructor(){super(...arguments),this.formatPainterEnable=!1,this.formatData=null}onload(){this.protyleOptions={toolbar:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo","|",{name:"format-painter",icon:"iconFormat",tipPosition:"n",tip:this.i18n.tips,click:o=>{if(this.protyle=o.protyle,!this.formatPainterEnable){const e=r();e?this.formatData={datatype:e.datatype,style:e.style}:this.formatData=null,this.formatPainterEnable=!0,document.body.dataset.formatPainterEnable="true",(0,u.fetchPost)("/api/notification/pushErrMsg",{msg:this.i18n.enable,timeout:7e3});const n=document.querySelector(".siyuan-plugin-formatPainter_brush_indicator");n&&(n.style.display="flex"),this.protyle.toolbar.range.collapse(!0),document.querySelectorAll(".protyle-toolbar").forEach(i=>{i.classList.contains("fn__none")||i.classList.add("fn__none")})}}}]},document.addEventListener("mouseup",o=>{if(this.formatPainterEnable){const e=window.getSelection();let n=!1;if(e&&e.rangeCount>0){const t=e.getRangeAt(0);if(t.toString()){const a=k(t.startContainer);if(t.endContainer.nodeType!==3&&t.endContainer.tagName==="DIV"&&t.endOffset===0&&t.endContainer.classList.contains("protyle-attr")&&a&&P(E(a),t,!1),this.protyle.toolbar.range=t,this.protyle.toolbar.setInlineMark(this.protyle,"clear","range"),this.protyle.toolbar.setInlineMark(this.protyle,"text","range"),!this.formatData)return;if(this.formatData.datatype){this.formatData.datatype.includes("inline-math")&&(this.protyle.toolbar.setInlineMark(this.protyle,"inline-math","range",{type:"inline-math"}),n=!0);const s=this.formatData.datatype.replace(/\b(inline-math|block-ref|a|text)\b/g,"").trim();s&&this.protyle.toolbar.setInlineMark(this.protyle,s,"range")}if(this.formatData.style){let s="text";if(n){s="inline-math";return}const{backgroundColor:p,color:y,fontSize:h,textShadow:m,webkitTextStroke:b,webkitTextFillColor:S}=_(this.formatData.style);p&&this.protyle.toolbar.setInlineMark(this.protyle,s,"range",{type:"backgroundColor",color:p}),y&&this.protyle.toolbar.setInlineMark(this.protyle,s,"range",{type:"color",color:y}),h&&this.protyle.toolbar.setInlineMark(this.protyle,s,"range",{type:"fontSize",color:h}),m&&this.protyle.toolbar.setInlineMark(this.protyle,s,"range",{type:"style4",color:m}),b&&this.protyle.toolbar.setInlineMark(this.protyle,s,"range",{type:"style2",color:b})}e.removeAllRanges()}}}}),document.addEventListener("keydown",o=>{if(o.key==="Escape"&&this.formatPainterEnable){this.formatPainterEnable=!1,document.body.dataset.formatPainterEnable="false",this.formatData=null,(0,u.fetchPost)("/api/notification/pushMsg",{msg:this.i18n.disable,timeout:7e3});const e=document.querySelector(".siyuan-plugin-formatPainter_brush_indicator");e&&(e.style.display="none")}});function r(){const o=window.getSelection();if(o.rangeCount>0){const e=o.getRangeAt(0);let n=e.startContainer;const t=e.endContainer;if(t.previousSibling&&t.previousSibling.nodeType===Node.ELEMENT_NODE){const a=t.previousSibling;a.tagName.toLowerCase()==="span"&&a.classList.contains("render-node")&&(n=a)}let i=n.nodeType===Node.TEXT_NODE?n.parentNode:n;for(;i&&!i.hasAttribute("data-type");)i=i.parentElement;if(i&&i.tagName.toLowerCase()==="span"){const a={html:i.outerHTML,datatype:i.getAttribute("data-type"),style:i.getAttribute("style")};return o.removeAllRanges(),a}}return o.removeAllRanges(),null}const l=(o,e,n,t=!1)=>{var i;if(!o)return!1;o.nodeType===3&&(o=o.parentElement);let a=o,s=!1;for(;a&&!s&&(t?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&((i=a.getAttribute(e))!=null&&i.split(" ").includes(n))||typeof n!="string"&&a.hasAttribute(e)?s=!0:a=a.parentElement;return s&&a},k=o=>{var e;const n=l(o,"data-node-id",null);return n&&n.tagName!=="BUTTON"&&((e=n.getAttribute("data-type"))!=null&&e.startsWith("Node"))?n:!1},E=o=>!o||o.getAttribute("contenteditable")==="true"&&!o.classList.contains("protyle-wysiwyg")?o:o.querySelector('[contenteditable="true"]'),P=(o,e,n=!0)=>{if(!o)return e;let t=o.lastChild;for(;t&&t.nodeType!==3;){if(t.nodeType!==3&&t.tagName==="BR")return e;t=t.lastChild}return t?(n?e.setStart(t,t.textContent.length):e.setEnd(t,t.textContent.length),e):(e.selectNodeContents(o),e)};function _(o){const e=o.split(";").filter(t=>t.trim()!==""),n={};return e.forEach(t=>{const[i,a]=t.split(":").map(s=>s.trim());n[i]=a}),{backgroundColor:n["background-color"],color:n.color,fontSize:n["font-size"],textShadow:n["text-shadow"],webkitTextStroke:n["-webkit-text-stroke"],webkitTextFillColor:n["-webkit-text-fill-color"]}}console.log(this.i18n.helloPlugin)}addDockBrushModeIndicator(){const r=document.createElement("div");r.classList.add("siyuan-plugin-formatPainter_brush_indicator","status__counter","toolbar__item","ariaLabel","blink-animation"),r.innerHTML='<svg class="icon"><use xlink:href="#iconFormat"></use></svg>',this.addStatusBar({element:r}),r.setAttribute("aria-label",this.i18n.closeTips),r.style.display="none";const l=document.createElement("style");l.textContent=`
            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0.2; }
                100% { opacity: 1; }
            }
            .blink-animation {
                animation: blink 1s infinite;
            }
        `,document.head.appendChild(l),r.addEventListener("click",()=>{this.toggleFormatPainter()})}toggleFormatPainter(){this.formatPainterEnable?((0,u.fetchPost)("/api/notification/pushMsg",{msg:this.i18n.disable,timeout:7e3}),document.body.dataset.formatPainterEnable="false"):((0,u.fetchPost)("/api/notification/pushErrMsg",{msg:this.i18n.enable,timeout:7e3}),document.body.dataset.formatPainterEnable="true"),this.formatPainterEnable=!this.formatPainterEnable;const r=document.querySelector(".siyuan-plugin-formatPainter_brush_indicator");r&&(r.style.display=this.formatPainterEnable?"flex":"none")}onLayoutReady(){this.addDockBrushModeIndicator()}onunload(){console.log(this.i18n.byePlugin)}uninstall(){console.log("uninstall")}}module.exports=f})();
